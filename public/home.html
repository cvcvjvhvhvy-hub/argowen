<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="/manifest.json">
    <title>Order Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-brand">
                    <div class="header-logo">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <span class="header-title">Order Pro</span>
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-name" id="headerUserName"></div>
                        <div class="user-role" id="headerUserRole"></div>
                    </div>
                    <div class="user-avatar" id="headerAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            </div>
        </header>

        <main class="app-content">
            <div id="grocerySection" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">مرحباً بك</h1>
                    <p class="page-subtitle">إدارة طلباتك بكل سهولة</p>
                </div>

                <div class="stats-grid" id="groceryStats">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-file-invoice"></i>
                        </div>
                        <div class="stat-value" id="totalInvoices">0</div>
                        <div class="stat-label">إجمالي الطلبات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-value" id="pendingInvoices">0</div>
                        <div class="stat-label">قيد الانتظار</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-value" id="approvedInvoices">0</div>
                        <div class="stat-label">تمت الموافقة</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-list"></i> طلباتي</h2>
                </div>

                <div id="groceryInvoicesList" class="cards-grid"></div>
            </div>

            <div id="merchantSection" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">الطلبات المتاحة</h1>
                    <p class="page-subtitle">قدم عروض أسعارك للطلبات</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                        <div class="stat-value" id="availableOrders">0</div>
                        <div class="stat-label">طلبات متاحة</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-handshake"></i>
                        </div>
                        <div class="stat-value" id="myBids">0</div>
                        <div class="stat-label">عروضي</div>
                    </div>
                </div>

                <div class="section-header">
                    <h2 class="section-title"><i class="fas fa-store"></i> طلبات البقالات</h2>
                </div>

                <div id="merchantInvoicesList" class="cards-grid"></div>
            </div>

            <div id="adminSection" style="display: none;">
                <div class="page-header">
                    <h1 class="page-title">لوحة التحكم</h1>
                    <p class="page-subtitle">إدارة النظام والمستخدمين</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label">المستخدمون</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">الطلبات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-value" id="groceriesCount">0</div>
                        <div class="stat-label">البقالات</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-value" id="merchantsCount">0</div>
                        <div class="stat-label">التجار</div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="orders">الطلبات</div>
                    <div class="tab" data-tab="users">المستخدمون</div>
                </div>

                <div id="ordersTab">
                    <div id="adminInvoicesList" class="cards-grid"></div>
                </div>

                <div id="usersTab" style="display: none;">
                    <div id="usersList" class="cards-grid"></div>
                </div>
            </div>
        </main>

        <button class="fab" id="fabBtn" style="display: none;" onclick="openCreateModal()">
            <i class="fas fa-plus"></i>
        </button>

        <nav class="bottom-nav">
            <div class="nav-items">
                <div class="nav-item active" data-page="home">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="nav-item" data-page="orders">
                    <i class="fas fa-file-invoice"></i>
                    <span>الطلبات</span>
                </div>
                <div class="nav-item" data-page="profile" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>خروج</span>
                </div>
            </div>
        </nav>
    </div>

    <div class="modal-overlay" id="createModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-plus-circle"></i> طلب جديد</h3>
                <button class="modal-close" onclick="closeModal('createModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">رقم الهاتف للتواصل</label>
                    <input type="tel" class="form-control" id="invoicePhone" placeholder="رقم الهاتف">
                </div>
                <div class="form-group">
                    <label class="form-label">عنوان التوصيل</label>
                    <input type="text" class="form-control" id="invoiceAddress" placeholder="العنوان بالتفصيل">
                </div>
                <div class="form-group">
                    <label class="form-label"><i class="fas fa-box"></i> المنتجات المطلوبة</label>
                    <div id="itemsContainer">
                        <div class="add-item-row">
                            <input type="text" class="form-control item-name" placeholder="اسم المنتج">
                            <input type="number" class="form-control item-qty" placeholder="الكمية" min="1" value="1">
                            <button type="button" class="remove-item-btn" onclick="removeItemRow(this)">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addItemRow()">
                        <i class="fas fa-plus"></i> إضافة منتج آخر
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createModal')">إلغاء</button>
                <button class="btn btn-primary" onclick="createInvoice()">
                    <i class="fas fa-paper-plane"></i> إرسال الطلب
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="bidModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-tags"></i> تقديم عرض سعر</h3>
                <button class="modal-close" onclick="closeModal('bidModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="bidItemsContainer"></div>
                <div class="invoice-price" style="margin-top: 20px;">
                    <span class="price-label">الإجمالي</span>
                    <span class="price-value" id="bidTotalPrice">0 ريال</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bidModal')">إلغاء</button>
                <button class="btn btn-success" onclick="submitBid()">
                    <i class="fas fa-check"></i> تقديم العرض
                </button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="viewBidsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-list-alt"></i> عروض الأسعار</h3>
                <button class="modal-close" onclick="closeModal('viewBidsModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="bidsListContainer"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        let currentUser = null;
        let currentInvoiceId = null;
        let currentItems = [];
        let allInvoices = [];

        async function init() {
            const response = await fetch('/api/user');
            const data = await response.json();
            if (!data.success) {
                window.location.href = '/login.html';
                return;
            }
            currentUser = data.user;
            updateHeader();
            showSection();
            loadData();
        }

        function updateHeader() {
            document.getElementById('headerUserName').textContent = currentUser.name;
            document.getElementById('headerUserRole').textContent = getRoleText(currentUser.role);
            const avatar = document.getElementById('headerAvatar');
            avatar.innerHTML = currentUser.name.charAt(0);
            avatar.style.background = currentUser.role === 'grocery' 
                ? 'linear-gradient(135deg, #4361ee 0%, #7209b7 100%)'
                : currentUser.role === 'merchant'
                ? 'linear-gradient(135deg, #f72585 0%, #7209b7 100%)'
                : 'linear-gradient(135deg, #06d6a0 0%, #4361ee 100%)';
        }

        function showSection() {
            document.getElementById('grocerySection').style.display = 'none';
            document.getElementById('merchantSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'none';
            document.getElementById('fabBtn').style.display = 'none';

            if (currentUser.role === 'grocery') {
                document.getElementById('grocerySection').style.display = 'block';
                document.getElementById('fabBtn').style.display = 'flex';
            } else if (currentUser.role === 'merchant') {
                document.getElementById('merchantSection').style.display = 'block';
            } else {
                document.getElementById('adminSection').style.display = 'block';
            }
        }

        async function loadData() {
            const invoicesRes = await fetch('/api/invoices');
            const invoicesData = await invoicesRes.json();
            allInvoices = invoicesData.invoices || [];

            if (currentUser.role === 'grocery') {
                renderGroceryView();
            } else if (currentUser.role === 'merchant') {
                renderMerchantView();
            } else {
                renderAdminView();
            }
        }

        function renderGroceryView() {
            const total = allInvoices.length;
            const pending = allInvoices.filter(i => i.status === 'pending').length;
            const priced = allInvoices.filter(i => i.status === 'priced').length;
            const approved = allInvoices.filter(i => i.status === 'approved').length;

            document.getElementById('totalInvoices').textContent = total;
            document.getElementById('pendingInvoices').textContent = pending + priced;
            document.getElementById('approvedInvoices').textContent = approved;

            const container = document.getElementById('groceryInvoicesList');
            if (allInvoices.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-inbox"></i>
                        <h3>لا توجد طلبات</h3>
                        <p>اضغط على زر + لإنشاء طلب جديد</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = allInvoices.map(inv => `
                <div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-id">
                            <i class="fas fa-hashtag"></i>
                            ${inv.id.slice(-6)}
                        </span>
                        <span class="status-badge status-${inv.status}">${getStatusText(inv.status)}</span>
                    </div>
                    <div class="invoice-body">
                        <div class="invoice-info">
                            <div class="invoice-info-item">
                                <i class="fas fa-calendar"></i>
                                ${new Date(inv.createdAt).toLocaleDateString('ar-YE')}
                            </div>
                            <div class="invoice-info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                ${inv.address}
                            </div>
                        </div>
                        <div class="invoice-items">
                            <div class="invoice-items-title">
                                <i class="fas fa-box"></i> المنتجات (${inv.items.length})
                            </div>
                            ${inv.items.slice(0, 3).map(item => `
                                <div class="item-row">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-qty">${item.quantity}</span>
                                </div>
                            `).join('')}
                            ${inv.items.length > 3 ? `<div class="item-row"><span style="color:var(--gray)">+ ${inv.items.length - 3} منتجات أخرى</span></div>` : ''}
                        </div>
                        ${inv.lowestPrice ? `
                            <div class="invoice-price">
                                <span class="price-label">أقل سعر</span>
                                <span class="price-value">${inv.lowestPrice} ريال</span>
                            </div>
                        ` : ''}
                        ${inv.status === 'priced' ? `
                            <div class="invoice-actions">
                                <button class="btn btn-primary" onclick="viewBids('${inv.id}')">
                                    <i class="fas fa-eye"></i> عرض العروض
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderMerchantView() {
            const pending = allInvoices.filter(i => i.status === 'pending' || i.status === 'priced');
            document.getElementById('availableOrders').textContent = pending.length;
            document.getElementById('myBids').textContent = '0';

            const container = document.getElementById('merchantInvoicesList');
            if (pending.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-store-slash"></i>
                        <h3>لا توجد طلبات متاحة</h3>
                        <p>سيتم إشعارك عند توفر طلبات جديدة</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = pending.map(inv => `
                <div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-id">
                            <i class="fas fa-store"></i>
                            ${inv.groceryName}
                        </span>
                        <span class="status-badge status-${inv.status}">${getStatusText(inv.status)}</span>
                    </div>
                    <div class="invoice-body">
                        <div class="invoice-info">
                            <div class="invoice-info-item">
                                <i class="fas fa-phone"></i>
                                ${inv.phone}
                            </div>
                            <div class="invoice-info-item">
                                <i class="fas fa-map-marker-alt"></i>
                                ${inv.address}
                            </div>
                        </div>
                        <div class="invoice-items">
                            <div class="invoice-items-title">
                                <i class="fas fa-box"></i> المنتجات المطلوبة
                            </div>
                            ${inv.items.map(item => `
                                <div class="item-row">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-qty">${item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                        <div class="invoice-actions">
                            <button class="btn btn-success" onclick="openBidModal('${inv.id}', ${JSON.stringify(inv.items).replace(/"/g, '&quot;')})">
                                <i class="fas fa-tag"></i> تقديم عرض
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function renderAdminView() {
            const usersRes = await fetch('/api/users');
            const usersData = await usersRes.json();
            const users = usersData.users || [];

            document.getElementById('totalUsers').textContent = users.length;
            document.getElementById('totalOrders').textContent = allInvoices.length;
            document.getElementById('groceriesCount').textContent = users.filter(u => u.role === 'grocery').length;
            document.getElementById('merchantsCount').textContent = users.filter(u => u.role === 'merchant').length;

            const invoicesContainer = document.getElementById('adminInvoicesList');
            invoicesContainer.innerHTML = allInvoices.map(inv => `
                <div class="invoice-card">
                    <div class="invoice-header">
                        <span class="invoice-id">
                            <i class="fas fa-hashtag"></i>
                            ${inv.groceryName}
                        </span>
                        <span class="status-badge status-${inv.status}">${getStatusText(inv.status)}</span>
                    </div>
                    <div class="invoice-body">
                        <div class="invoice-items">
                            ${inv.items.map(item => `
                                <div class="item-row">
                                    <span class="item-name">${item.name}</span>
                                    <span class="item-qty">${item.quantity}</span>
                                </div>
                            `).join('')}
                        </div>
                        ${inv.lowestPrice ? `
                            <div class="invoice-price">
                                <span class="price-label">أقل سعر</span>
                                <span class="price-value">${inv.lowestPrice} ريال</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('') || '<div class="empty-state" style="grid-column:1/-1"><i class="fas fa-inbox"></i><h3>لا توجد طلبات</h3></div>';

            const usersContainer = document.getElementById('usersList');
            usersContainer.innerHTML = users.map(user => `
                <div class="user-card">
                    <div class="user-card-avatar ${user.role}">
                        ${user.name.charAt(0)}
                    </div>
                    <div class="user-card-info">
                        <div class="user-card-name">${user.name}</div>
                        <div class="user-card-details">
                            <i class="fas fa-phone"></i> ${user.phone}
                        </div>
                    </div>
                    <span class="user-card-role role-${user.role}">${getRoleText(user.role)}</span>
                </div>
            `).join('');
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                const tabName = tab.dataset.tab;
                document.getElementById('ordersTab').style.display = tabName === 'orders' ? 'block' : 'none';
                document.getElementById('usersTab').style.display = tabName === 'users' ? 'block' : 'none';
            });
        });

        function openCreateModal() {
            document.getElementById('createModal').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function addItemRow() {
            const container = document.getElementById('itemsContainer');
            const row = document.createElement('div');
            row.className = 'add-item-row';
            row.innerHTML = `
                <input type="text" class="form-control item-name" placeholder="اسم المنتج">
                <input type="number" class="form-control item-qty" placeholder="الكمية" min="1" value="1">
                <button type="button" class="remove-item-btn" onclick="removeItemRow(this)">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(row);
        }

        function removeItemRow(btn) {
            const rows = document.querySelectorAll('.add-item-row');
            if (rows.length > 1) {
                btn.closest('.add-item-row').remove();
            }
        }

        async function createInvoice() {
            const phone = document.getElementById('invoicePhone').value || currentUser.phone;
            const address = document.getElementById('invoiceAddress').value || currentUser.address;
            const rows = document.querySelectorAll('#itemsContainer .add-item-row');
            const items = [];

            rows.forEach(row => {
                const name = row.querySelector('.item-name').value.trim();
                const qty = parseInt(row.querySelector('.item-qty').value) || 1;
                if (name) items.push({ name, quantity: qty });
            });

            if (items.length === 0) {
                showToast('أضف منتج واحد على الأقل', true);
                return;
            }

            const response = await fetch('/api/invoices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ phone, address, items })
            });

            if (response.ok) {
                closeModal('createModal');
                showToast('تم إنشاء الطلب بنجاح');
                loadData();
            }
        }

        function openBidModal(invoiceId, items) {
            currentInvoiceId = invoiceId;
            currentItems = items;
            const container = document.getElementById('bidItemsContainer');
            container.innerHTML = items.map((item, i) => `
                <div class="form-group">
                    <label class="form-label">${item.name} (${item.quantity})</label>
                    <input type="number" class="form-control bid-price" data-index="${i}" placeholder="السعر للوحدة" min="0" oninput="updateBidTotal()">
                </div>
            `).join('');
            document.getElementById('bidTotalPrice').textContent = '0 ريال';
            document.getElementById('bidModal').classList.add('active');
        }

        function updateBidTotal() {
            const prices = document.querySelectorAll('.bid-price');
            let total = 0;
            prices.forEach((input, i) => {
                const price = parseFloat(input.value) || 0;
                total += price * currentItems[i].quantity;
            });
            document.getElementById('bidTotalPrice').textContent = total + ' ريال';
        }

        async function submitBid() {
            const prices = document.querySelectorAll('.bid-price');
            const itemPrices = [];
            let total = 0;

            prices.forEach((input, i) => {
                const price = parseFloat(input.value) || 0;
                itemPrices.push({ name: currentItems[i].name, price });
                total += price * currentItems[i].quantity;
            });

            const response = await fetch('/api/bids', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ invoiceId: currentInvoiceId, totalPrice: total, itemPrices })
            });

            if (response.ok) {
                closeModal('bidModal');
                showToast('تم تقديم العرض بنجاح');
                loadData();
            }
        }

        async function viewBids(invoiceId) {
            currentInvoiceId = invoiceId;
            const response = await fetch(`/api/bids/${invoiceId}`);
            const data = await response.json();
            const container = document.getElementById('bidsListContainer');

            if (data.bids.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-inbox"></i><h3>لا توجد عروض بعد</h3></div>';
            } else {
                container.innerHTML = data.bids.map(bid => `
                    <div class="invoice-card" style="margin-bottom: 12px;">
                        <div class="invoice-header">
                            <span class="invoice-id">
                                <i class="fas fa-user"></i>
                                ${bid.merchantName}
                            </span>
                        </div>
                        <div class="invoice-body">
                            <div class="invoice-price">
                                <span class="price-label">السعر الإجمالي</span>
                                <span class="price-value">${bid.totalPrice} ريال</span>
                            </div>
                            <button class="btn btn-success" onclick="approveBid('${invoiceId}', '${bid.merchantId}')">
                                <i class="fas fa-check"></i> قبول العرض
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            document.getElementById('viewBidsModal').classList.add('active');
        }

        async function approveBid(invoiceId, merchantId) {
            await fetch(`/api/invoices/${invoiceId}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ merchantId })
            });
            closeModal('viewBidsModal');
            showToast('تمت الموافقة على العرض');
            loadData();
        }

        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login.html';
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas fa-${isError ? 'times-circle' : 'check-circle'}"></i> ${message}`;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function getStatusText(status) {
            const texts = { pending: 'قيد الانتظار', priced: 'تم التسعير', approved: 'موافق عليه' };
            return texts[status] || status;
        }

        function getRoleText(role) {
            const texts = { grocery: 'بقالة', merchant: 'تاجر', admin: 'مسؤول' };
            return texts[role] || role;
        }

        init();
    </script>
</body>
</html>
